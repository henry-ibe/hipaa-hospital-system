name: Hospital Region Deployment

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region Code (ny, ca, tx, fl, etc)'
        required: true
        type: string
      action:
        description: 'Action'
        required: true
        type: string
        default: 'apply'

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform-version: 1.5.0
          terraform_wrapper: false

      - name: Deploy or Destroy
        id: terraform
        run: |
          terraform init
          terraform workspace select ${{ github.event.inputs.region }} || terraform workspace new ${{ github.event.inputs.region }}
          
          if [ ! -f "${{ github.event.inputs.region }}.tfvars" ]; then
            echo 'hospital_name = "Hospital-${{ github.event.inputs.region }}"' > ${{ github.event.inputs.region }}.tfvars
            echo 'location = "${{ github.event.inputs.region }}"' >> ${{ github.event.inputs.region }}.tfvars
            echo 'allowed_ip_ranges = ["3.80.190.60/32"]' >> ${{ github.event.inputs.region }}.tfvars
            echo 'allowed_states = ["${{ github.event.inputs.region }}"]' >> ${{ github.event.inputs.region }}.tfvars
          fi
          
          terraform ${{ github.event.inputs.action }} -var-file="${{ github.event.inputs.region }}.tfvars" -auto-approve
          
          if [ "${{ github.event.inputs.action }}" = "apply" ]; then
            SERVER_IP=$(terraform output -raw app_server_ip)
            echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          fi

      - name: Update DynamoDB (Apply)
        if: github.event.inputs.action == 'apply'
        run: |
          REGION="${{ github.event.inputs.region }}"
          SERVER_IP="${{ steps.terraform.outputs.server_ip }}"
          
          case "$REGION" in
            ny) CITY="New York"; HOSPITAL="Mount Sinai Hospital"; LAT="40.7128"; LON="-74.0060"; AWS_REGION="us-east-1";;
            ca) CITY="Los Angeles"; HOSPITAL="UCLA Medical Center"; LAT="34.0522"; LON="-118.2437"; AWS_REGION="us-west-2";;
            il) CITY="Chicago"; HOSPITAL="Northwestern Memorial"; LAT="41.8781"; LON="-87.6298"; AWS_REGION="us-east-2";;
            tx) CITY="Dallas"; HOSPITAL="Baylor Medical Center"; LAT="32.7767"; LON="-96.7970"; AWS_REGION="us-south-1";;
            fl) CITY="Miami"; HOSPITAL="Jackson Memorial"; LAT="25.7617"; LON="-80.1918"; AWS_REGION="us-east-1";;
            wa) CITY="Seattle"; HOSPITAL="UW Medical Center"; LAT="47.6062"; LON="-122.3321"; AWS_REGION="us-west-2";;
            *) CITY="Unknown"; HOSPITAL="Hospital-$REGION"; LAT="39.8283"; LON="-98.5795"; AWS_REGION="us-east-1";;
          esac
          
          aws dynamodb put-item \
            --table-name hospital-deployments \
            --item "{
              \"regionCode\": {\"S\": \"$REGION\"},
              \"city\": {\"S\": \"$CITY\"},
              \"state\": {\"S\": \"${REGION^^}\"},
              \"hospitalName\": {\"S\": \"$HOSPITAL\"},
              \"awsRegion\": {\"S\": \"$AWS_REGION\"},
              \"status\": {\"S\": \"active\"},
              \"ip\": {\"S\": \"$SERVER_IP\"},
              \"coordinates\": {\"L\": [{\"N\": \"$LAT\"}, {\"N\": \"$LON\"}]},
              \"deployedAt\": {\"S\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}
            }"
          
          echo "✅ Updated DynamoDB with $REGION deployment"

      - name: Remove from DynamoDB (Destroy)
        if: github.event.inputs.action == 'destroy'
        run: |
          REGION="${{ github.event.inputs.region }}"
          
          # Delete the DynamoDB record
          aws dynamodb delete-item \
            --table-name hospital-deployments \
            --key "{\"regionCode\": {\"S\": \"$REGION\"}}"
          
          echo "✅ Removed $REGION from DynamoDB"
          
          # Delete the workspace
          terraform workspace select default
          terraform workspace delete $REGION || echo "Workspace already deleted"
