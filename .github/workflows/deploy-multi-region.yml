name: Deploy Hospital System to AWS Regions

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Target Region Code (e.g., ny, ca, tx, fl)'
        required: true
        type: string
      action:
        description: 'Terraform Action'
        required: true
        type: choice
        default: 'apply'
        options:
          - plan
          - apply
          - destroy

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform-version: 1.5.0

      - name: Terraform Init
        run: terraform init

      - name: Deploy Region
        run: |
          REGION="${{ github.event.inputs.region }}"
          ACTION="${{ github.event.inputs.action }}"
          
          echo "Deploying to region: $REGION"
          echo "Action: $ACTION"
          
          # Create workspace if it doesn't exist
          terraform workspace select $REGION || terraform workspace new $REGION
          
          # Check if tfvars file exists, if not create a basic one
          if [ ! -f "${REGION}.tfvars" ]; then
            echo "Creating ${REGION}.tfvars..."
            cat > ${REGION}.tfvars << TFVARS
hospital_name = "Hospital-${REGION}"
location = "Region ${REGION}"
allowed_ip_ranges = ["3.80.190.60/32"]
allowed_states = ["${REGION^^}"]
TFVARS
          fi
          
          # Run terraform
          if [ "$ACTION" = "apply" ]; then
            terraform apply -var-file="${REGION}.tfvars" -auto-approve
          elif [ "$ACTION" = "destroy" ]; then
            terraform destroy -var-file="${REGION}.tfvars" -auto-approve
          else
            terraform plan -var-file="${REGION}.tfvars"
          fi

      - name: Output Results
        if: always()
        run: |
          echo "### ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ github.event.inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
